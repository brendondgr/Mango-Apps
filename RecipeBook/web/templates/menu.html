{% extends "kitchen.html" %}

{% block title %}Menu - ShortSpork{% endblock %}
{% block description %}Browse and filter recipes by ingredients you have{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/menu.css') }}">
{% endblock %}

{% block nav_links %}
<a href="{{ url_for('index') }}" class="nav-link active">Menu</a>
<a href="{{ url_for('prep_station') }}" class="nav-link">Prep Station</a>
{% endblock %}

{% block content %}
<div class="menu-layout">
    <!-- Sidebar Filter -->
    <aside class="filter-sidebar glass">
        <div class="filter-header main-filter-header">
            <h2 class="filter-title">Filters</h2>
            <div class="header-actions" style="display: flex; gap: var(--space-2); align-items: center;">
                <button class="btn btn-ghost btn-xs" id="clear-filters" style="font-size: 0.75rem; padding: 0.25rem 0.5rem; height: auto;">Clear</button>
                <button id="sidebar-collapse-btn" class="btn-icon" aria-label="Collapse sidebar">
                    <span class="toggle-icon-chevron">‹</span>
                </button>
            </div>
        </div>

        <!-- Primary Filters: Cuisine Region -->
        <div class="filter-category primary-category" id="cuisine-filter-section">
            <button class="category-toggle" aria-expanded="false" data-category="cuisine">
                <span class="category-name">Cuisine</span>
                <!-- Active active count badge -->
                <span class="primary-active-count badge badge-primary" id="cuisine-active-count" style="display: none;">0</span>
                <!-- Total count badge populated by JS -->
                <span class="category-count badge badge-muted-gray" id="cuisine-total-count">0</span>
                <span class="toggle-icon">▼</span>
            </button>
            <div class="category-items collapsed" id="cuisine-filter-options">
                <!-- Populated via JS -->
                <p class="filter-loading">Loading...</p>
            </div>
        </div>
        
        <!-- Primary Filters: Meal Type -->
        <div class="filter-category primary-category" id="meal-filter-section">
            <button class="category-toggle" aria-expanded="false" data-category="meal">
                <span class="category-name">Meal Type</span>
                <!-- Active active count badge -->
                <span class="primary-active-count badge badge-primary" id="meal-active-count" style="display: none;">0</span>
                <!-- Total count badge populated by JS -->
                <span class="category-count badge badge-muted-gray" id="meal-total-count">0</span>
                <span class="toggle-icon">▼</span>
            </button>
            <div class="category-items collapsed" id="meal-filter-options">
                <!-- Populated via JS -->
                <p class="filter-loading">Loading...</p>
            </div>
        </div>
        
        <div class="filter-divider"></div>
        
        <div class="filter-header">
            <h2 class="filter-title">My Pantry</h2>
            <p class="filter-subtitle">Select ingredients you have</p>
        </div>
        
        <div class="filter-categories">
            {% for category, items in ingredients.items() %}
            <div class="filter-category">
                <button class="category-toggle" aria-expanded="false" data-category="{{ category }}">
                    <span class="category-name">{{ category }}</span>
                    <span class="category-count badge badge-muted-gray">{{ items|length }}</span>
                    <span class="toggle-icon">▼</span>
                </button>
                <div class="category-items collapsed">
                    {% for item in items %}
                    <label class="ingredient-item">
                        <input type="checkbox" class="checkbox ingredient-checkbox" 
                               data-ingredient-id="{{ item.id }}"
                               data-ingredient-name="{{ item.name }}">
                        <span class="ingredient-name">{{ item.name }}</span>
                    </label>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>

        

    </aside>
    
    <!-- Main Recipe Grid -->
    <main class="recipe-grid-container">
        <div class="grid-header">
            <div style="display: flex; align-items: center; gap: var(--space-3);">
                <button id="sidebar-expand-btn" class="btn-icon" aria-label="Show filters" style="display: none;">
                    <span class="toggle-icon-chevron">›</span>
                </button>
                <h1 class="grid-title">Recipes</h1>
            </div>
            <p class="grid-info" id="recipe-count">
                <span id="count-number">{{ recipes|length }}</span> recipes available
            </p>
        </div>
        
        <!-- Loading Spinner -->
        <div class="loading-overlay" id="loading-overlay" style="display: none;">
            <div class="spinner"></div>
        </div>
        
        <!-- Recipe Grid -->
        <div class="recipe-grid" id="recipe-grid">
            {% for recipe in recipes %}
            <article class="card-recipe" data-recipe-id="{{ recipe.id }}">
                <div class="card-recipe-image-container recipe-carousel">
                    <div class="card-badges-overlay" style="z-index: 5;">
                        {% if recipe.match_percentage %}
                        <span class="badge badge-match">
                            {{ recipe.match_percentage }}% match
                        </span>
                        {% endif %}
                    </div>
                    
                    <div class="carousel-images">
                        {% if recipe.images and recipe.images|length > 0 %}
                            {% for img in recipe.images %}
                                <img src="{{ img }}" 
                                     alt="{{ recipe.title }}" 
                                     class="carousel-image {{ 'active' if loop.first else '' }}">
                            {% endfor %}
                        {% else %}
                             <img src="https://placehold.co/400x250/CCCCCC/666?text=Recipe" 
                                  alt="{{ recipe.title }}" 
                                  class="carousel-image active">
                        {% endif %}
                    </div>
                    
                    {% if recipe.images and recipe.images|length > 1 %}
                    <button class="carousel-nav carousel-prev" aria-label="Previous">&lsaquo;</button>
                    <button class="carousel-nav carousel-next" aria-label="Next">&rsaquo;</button>
                    {% endif %}
                </div>
                <div class="card-recipe-content">
                    <h3 class="card-recipe-title">{{ recipe.title }}</h3>
                    <p class="card-recipe-description">{{ recipe.description }}</p>
                    <div class="card-recipe-meta">
                        <div class="meta-tags-right">
                            {% if recipe.cuisine_region %}
                                {% set cuisine_tags = split_tags(recipe.cuisine_region) %}
                                {% if cuisine_tags %}
                                    <span class="badge badge-sm badge-{{ get_tag_color(cuisine_tags[0]) }}">
                                        {{ cuisine_tags[0] }}{% if cuisine_tags|length > 1 %} + {{ cuisine_tags|length - 1 }}{% endif %}
                                    </span>
                                {% endif %}
                            {% endif %}
                            
                            {% if recipe.meal_type %}
                                {% set meal_tags = split_tags(recipe.meal_type) %}
                                {% if meal_tags %}
                                    <span class="badge badge-sm badge-{{ get_tag_color(meal_tags[0]) }}">
                                        {{ meal_tags[0] }}{% if meal_tags|length > 1 %} + {{ meal_tags|length - 1 }}{% endif %}
                                    </span>
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </article>
            {% endfor %}
        </div>
        
        <!-- Empty State -->
        <div class="empty-state" id="empty-state" style="display: none;">
            <h3 class="empty-title">No recipes match your ingredients</h3>
            <p class="empty-message">Try selecting different ingredients or clear your filters.</p>
        </div>
    </main>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/carousel.js') }}"></script>
<script src="{{ url_for('static', filename='js/fridge.js') }}"></script>
<script src="{{ url_for('static', filename='js/waiter.js') }}"></script>
{% endblock %}
